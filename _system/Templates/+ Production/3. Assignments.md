<%*
const templateType = "create";
const description = "can be shared with other users";

// Configuration
const FOLDER = "Notes/Assignments";
const NOTE_TEMPLATE = "_system/Templates/_Primary/+Assignments.md";
const PROMPT = "Assignment Title";

// Helper function to format the title
const formatTitle = (title) => title.trim().replace(/[.]/g, ' ').replace(/\s+/g, ' ');

// Create new note function
async function createNewNote(name, wasSelectedText = false) {
    try {
        // Create folder if it doesn't exist
        if (!app.vault.getAbstractFileByPath(FOLDER)) {
            await app.vault.createFolder(FOLDER);
        }

        // Get template
        const templateFile = tp.file.find_tfile(NOTE_TEMPLATE);
        if (!templateFile) {
            throw new Error(`Template file not found: ${NOTE_TEMPLATE}`);
        }

        // Create new file
        const title = formatTitle(name);
        const newFilePath = `${FOLDER}/${title}.md`;
        const templateContent = await app.vault.read(templateFile);
        const newFile = await app.vault.create(newFilePath, templateContent);

        // Get the current active leaf
        const activeLeaf = app.workspace.activeLeaf;

        // Open the new file in a new tab
        await app.workspace.openLinkText(newFile.path, '', true);

        // If there was selected text, switch focus back to the original note
        if (wasSelectedText) {
            await app.workspace.setActiveLeaf(activeLeaf);
        }

        // Return the file object for further processing
        return newFile;
    } catch (error) {
        console.error("Error creating note:", error);
        new Notice(`Error: ${error.message}`);
        return null;
    }
}

// Main function
async function main() {
    try {
        const selectedText = tp.file.selection();
        
        if (selectedText) {
            // Create note from selected text
            const newFile = await createNewNote(selectedText, true);
            if (newFile) {
                // Return wikilink to replace selected text
                return `[[${newFile.basename}]] `;
            }
        } else {
            // Prompt for name
            const name = await tp.system.prompt(PROMPT);
            if (name?.trim()) {
                await createNewNote(name, false);
            }
        }
        
        return '';
    } catch (error) {
        console.error("Error in main function:", error);
        new Notice(`Error: ${error.message}`);
        return '';
    }
}

// Run the main function and use its return value
tR += await main();
%>