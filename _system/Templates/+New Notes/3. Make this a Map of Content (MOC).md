<%*
// METADJUST - AUTO MOC TOGGLE
const templateType = "insert";

// Get current file
const file = tp.file.find_tfile(tp.file.title);
if (file) {
    // Get current type value if it exists
    let currentType = "";
    
    try {
        const dv = this.app.plugins.plugins["dataview"].api;
        const currentPage = dv.page(file.path);
        currentType = (currentPage.type || "").toLowerCase();
    } catch {
        // Silently continue if dataview isn't available or type isn't set
    }
    
    // If current type is not 'moc', set it to 'moc'
    if (currentType !== "moc") {
        // Update YAML frontmatter to moc
        await app.fileManager.processFrontMatter(file, (frontmatter) => {
            frontmatter.type = "moc";
            if (!frontmatter.class) frontmatter.class = "Notes";
            if (!frontmatter.category) frontmatter.category = "Notes";
        });
        
        // Get the topic tag from user
        const topicTag = await tp.system.prompt("Enter the main tag for this MOC (use hyphens for multi-word tags, e.g., digital-twins, contribution-systems):");
        
        if (topicTag) {
            // Add the tag to frontmatter
            await app.fileManager.processFrontMatter(file, (frontmatter) => {
                if (!frontmatter.tags) {
                    frontmatter.tags = [topicTag];
                } else if (Array.isArray(frontmatter.tags)) {
                    if (!frontmatter.tags.includes(topicTag)) {
                        frontmatter.tags.push(topicTag);
                    }
                } else {
                    frontmatter.tags = [frontmatter.tags, topicTag];
                }
            });
            
            // Get current content to extract Notes section
            const currentContent = await app.vault.read(file);
            
            // Extract Notes section if it exists
            let notesSection = '';
            const notesMatch = currentContent.match(/# Notes\n([\s\S]*?)(?=\n# |$)/);
            if (notesMatch && notesMatch[1].trim()) {
                notesSection = '\n\n# Notes\n' + notesMatch[1].trim() + '\n';
            }
            
            // Get frontmatter
            const frontmatterMatch = currentContent.match(/^---\n[\s\S]*?\n---\n/);
            const frontmatter = frontmatterMatch ? frontmatterMatch[0] : '';
            
            // Generate MOC content - using template literal with proper escaping
            const bt = '`';
            const bt3 = bt + bt + bt;
            
            const mocContent = `

> **About this MOC:** This note automatically compiles all notes tagged with #${topicTag}. It updates dynamically - new sources and notes will appear automatically.

---

## ðŸ“š Sources

### Zotero (Academic Papers)

Shows papers you've tagged directly OR that have tagged Reference Notes.

${bt3}dataviewjs
const mocTags = dv.current().file.tags;

const taggedRefNotes = dv.pages('"Synthesis/Reference Notes"')
  .where(p => p.class === "Reference_Notes" 
    && p.file.tags && mocTags.some(mt => p.file.tags.some(t => String(t).includes(String(mt)))));

const sourcesFromRefNotes = taggedRefNotes
  .map(ref => {
    if (!ref.source) return null;
    const sourceMatch = String(ref.source).match(/\\[\\[.*?([^\\/\\|]+?)(?:\\|.*?)?\\]\\]/);
    return sourceMatch ? sourceMatch[1].replace('.md', '') : null;
  })
  .filter(s => s);

const zoteroSources = dv.pages('"Inputs/Zotero"')
  .where(p => p.class === "Sources");

const filteredSources = zoteroSources
  .where(z => 
    (z.file.tags && mocTags.some(mt => z.file.tags.some(t => String(t).includes(String(mt)))))
    || sourcesFromRefNotes.includes(z.file.name)
  );

if (filteredSources.length > 0) {
  dv.table(
    ["Author", "Title", "Type", "Imported"],
    filteredSources
      .sort(p => p.date_saved, 'desc')
      .map(p => [p.author || "", p.title || "", p.itemType || "", p.date_saved || ""])
  );
} else {
  dv.paragraph("No matching sources found");
}
${bt3}

### Readwise (Articles & Highlights)

${bt3}dataview
TABLE author as "Author", title as "Title", date_saved as "Imported"
FROM "Inputs/Readwise"
WHERE class = "Sources"
  AND (
    any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
    OR any(this.file.tags, (t) => contains(file.content, "#" + t))
    OR any(this.file.tags, (t) => contains(file.content, "<!-- #" + t + " -->"))
  )
SORT date_saved DESC
${bt3}

---

## ðŸ”¬ Reference Notes

Your analysis and synthesis of sources on this topic.

${bt3}dataview
TABLE source as "Source", noteAuthor as "Analyst", file.cday as "Created"
FROM "Synthesis/Reference Notes"
WHERE class = "Reference_Notes"
  AND any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
SORT file.cday DESC
${bt3}

---

## ðŸ’¬ Quotes

Captured quotes on this topic.

${bt3}dataview
TABLE source as "Source", title as "Quote Preview", file.cday as "Created"
FROM "Synthesis/Quotes"
WHERE class = "Quotes"
  AND any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
SORT file.cday DESC
${bt3}

---

## ðŸ“ Field Notes & Memos

Your thoughts, observations, and fieldwork related to this topic.

${bt3}dataview
TABLE note as "Description", file.cday as "Created"
FROM "Notes"
WHERE any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
SORT file.cday DESC
${bt3}

---

## ðŸ‘¥ Key People

Researchers, authors, and stakeholders in this research area.

${bt3}dataview
TABLE title as "Role/Affiliation"
FROM "People"
WHERE any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
SORT file.name ASC
${bt3}

---

## ðŸ“‹ Related MOCs

Other maps of content that connect to this topic.

${bt3}dataview
LIST
WHERE type = "moc" 
  AND file.name != this.file.name
  AND any(file.tags, (t) => any(this.file.tags, (mt) => contains(string(t), string(mt))))
${bt3}

---

## ðŸ”— Connected Notes

Related notes and cross-references.

${bt3}dataview
TABLE file.outlinks as "Links To", file.inlinks as "Links From"
FROM [[${file.name}]]
WHERE file.name != this.file.name
SORT file.name ASC
${bt3}

---


## ðŸ“Œ Key Themes & Questions

*Add your own notes, questions, and emerging themes here:*

- 
- 

---

## ðŸŽ¯ Next Steps

- [ ] 
- [ ] 

`;
            
            // Combine: frontmatter + notes section + MOC content
            await app.vault.modify(file, frontmatter + notesSection + mocContent);
            
            console.log(`Note converted to MOC with tag: ${topicTag}`);
        }
    } else {
        // If it's already 'moc', ask for confirmation before changing to 'note'
        const confirmOptions = ["Downgrade to note", "Keep as MOC"];
        const confirmResult = await tp.system.suggester(
            confirmOptions,
            [true, false],
            false,
            "This is already a MOC. Change to note?"
        );
        
        // If user confirms, change to 'note'
        if (confirmResult === true) {
            await app.fileManager.processFrontMatter(file, (frontmatter) => {
                frontmatter.type = "note";
            });
            
            console.log("Note type changed to note");
        } else {
            console.log("Note remains as MOC");
        }
    }
}
-%>
